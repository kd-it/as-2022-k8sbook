# ã‚µãƒ¼ãƒ“ã‚¹

ã“ã“ã¾ã§ã§ã€ãƒãƒƒãƒ‰ã«ç¹‹ãŒã‚‹ãƒªã‚½ãƒ¼ã‚¹ãŒæ­ä¹—ã—ã¾ã—ãŸã€‚

- Pod
- Deployment
- StatefulSet

ã“ã‚Œã‚‰ã¨ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã®çµ„ã¿åˆã‚ã›ã§ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ è‡ªä½“ã‚’ã‚³ãƒ³ãƒ†ãƒŠã§èµ°ã‚‰ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã—ã‹ã—ã“ã®ã¾ã¾ã ã¨ãã‚Œãã‚ŒãŒå€‹åˆ¥ã«å‹•ã„ã¦ã„ã‚‹ã ã‘ã®ãŸã‚ã€ä»¥ä¸‹ã®ã“ã¨ãŒã¾ã ã§ãã¦ã„ã¾ã›ã‚“ã€‚

- ã‚ã‚‹ãƒãƒƒãƒ‰ãŒåŒã˜ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®åˆ¥ã®ãƒãƒƒãƒ‰ã«å¯¾ã—ã¦ã®æ¥ç¶šãŒã—ã«ãã„
    - å¯¾è±¡ãƒãƒƒãƒ‰ã®IPãŒã‚ã‹ã‚Œã°ã©ã†ã«ã‹ãªã‚‹ã‘ã©ä¸å®šãªã®ã§é›£ã—ã„
- å¤–éƒ¨ã«å¯¾ã™ã‚‹å…¬é–‹(å¯èƒ½)ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦èªè­˜ã§ããªã„

ã“ã‚Œã‚‰ã«å¯¾å¿œã™ã‚‹ãŸã‚ã®æ–¹æ³•ã¨ã—ã¦ã€**ã‚µãƒ¼ãƒ“ã‚¹**(`Service`)ã¨ã„ã†ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ã¾ã™ã€‚
ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã€ãƒãƒƒãƒ‰ã«å¯¾ã—ã¦å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®æº–å‚™ã‚’ã—ã¦ãã‚Œã¾ã™ã€‚
å…·ä½“çš„ã«ã¯ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒã‚¹ã‚¿ãƒ¼ä¸Šã«å­˜åœ¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(etcdã‚„coredns)ã«ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ç™»éŒ²ã—ã€DNSã®å½¢ã§å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«å¯¾ã—ã¦å…¬é–‹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

minikubeã«ã‚ˆã‚‹é–‹ç™ºç’°å¢ƒã®å ´åˆã€æœ¬ç•ªç’°å¢ƒã®ã‚ˆã†ã«å®Œå…¨ã«ç‹¬è‡ªã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ›ã‚¹ãƒˆåã§ã®å…¬é–‹ã¯ã»ã¼è¡Œãˆã¾ã›ã‚“ã€‚å®Ÿéš›ã«å…¬é–‹ã™ã‚‹ã¨ãã¯ã€åˆ©ç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®æ–¹å¼ã«å¾“ã†å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã“ã“ã§ã¯æ®‹å¿µãªãŒã‚‰(æœ¬å½“ã®æ„å‘³ã§ã®ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ç©ºé–“ã¸ã®)å®Œå…¨ãªå…¬é–‹ã¯è¡Œãˆã¾ã›ã‚“ã€‚

ã¨ã¯ã„ãˆã€ãã“ã«è‡³ã‚‹åŸºæœ¬ãƒ«ãƒ¼ãƒˆã¯ç¢ºèªã§ãã‚‹ã®ã§ã€è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## åŸºæœ¬ã®ç’°å¢ƒã‚’ä½œã£ã¦ã¿ã‚‹

ã¾ãš2ã¤ã®ãƒãƒƒãƒ‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã§ä½œã£ã¦ã¿ã¾ã™ã€‚

- Apache httpdã‚’ä½¿ã£ãŸWebã‚µãƒ¼ãƒãƒ¼(ãŸã ã— `It's works.` ã®ã¿)
- Alpineã‚’ç”¨ã„ãŸã‚·ã‚§ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨ãƒãƒƒãƒ‰

ã§ã¯Webã‚µãƒ¼ãƒãƒ¼ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’ä½œã‚Šã¾ã™ã€‚

```{literalinclude} codes/service-example/web.yml
:caption: Webã‚µãƒ¼ãƒãƒ¼å´ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ(web.yml)
:language: yaml
```

ç‰¹ã«ã²ã­ã‚Šã®ãªã„å˜ãªã‚‹Webã‚µãƒ¼ãƒãƒ¼(Apache)ã§ã™ã€‚
ãƒªã‚½ãƒ¼ã‚¹ä¸Šã®å•é¡ŒãŒç„¡ã‘ã‚Œã°æ™®é€šã«ã†ã”ãã‚‚ã®ã§ã™ã€‚

ç¶šã„ã¦ã‚·ã‚§ãƒ«å´ã§ã™ã€‚ã“ã¡ã‚‰ã‚‚ç‰¹ã«ã²ã­ã‚Šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```{literalinclude} codes/service-example/shell.yml
:caption: ã‚·ã‚§ãƒ«ã‚¢ã‚¯ã‚»ã‚¹(Alpine)å´ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ(shell.yml)
:language: yaml
```

ä¸¡æ³•ã‚’é©ç”¨ã—ã€shellå´ã«ã¦ `sh` ã‚’èµ·å‹•ã—ã¦webå´ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦ã¿ã¾ã™ã€‚
`curl` ã¯å…¥ã£ã¦ã„ãªã„ãŸã‚ã€ `wget` ã§å¯¾å¿œã—ã¾ã™ã€‚

```{code-block} pwsh
:caption: deploy/shellã«ã¦ã‚·ã‚§ãƒ«ã‚’èµ·å‹•ã—ã¦webã«æ¥ç¶šã—ã¦ã¿ã‚‹

PS> kubectl exec -it deploy/shell -- sh
/ # wget -O- web
wget: bad address 'web'
/ # exit # æŠœã‘ã‚‹
```

webã¨ã„ã†åå‰ã§æ¥ç¶šã—ã‚ˆã†ã¨æ€ã£ã¦ã‚‚ã‚ã‹ã‚Šã¾ã›ã‚“ã®ã§ã€æ¥ç¶šã®ã—ã‚ˆã†ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

## é‚ªæ‚ªãªæ–¹æ³•ã§æ¥ç¶šã—ã¦ã¿ã‚‹

ãã‚Œãã‚Œãƒãƒƒãƒ‰ã¨ã—ã¦å­˜åœ¨ã¯ã—ã¦ã„ã‚‹ã¯ãšãªã®ã§ã€å­˜åœ¨ã™ã‚‹ãƒãƒƒãƒ‰ã®è©³ç´°ã‚’ç¢ºèªã™ã‚‹ã¨ã€ä¸€å¿œå†…éƒ¨ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```{code-block} pwsh
:caption: Webã‚µãƒ¼ãƒãƒ¼å´ã®ãƒãƒƒãƒ‰ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¢ç´¢ã™ã‚‹ä¾‹

# ãƒãƒƒãƒ‰åã‚’ç¢ºèªã™ã‚‹
PS> kubectl get pods
NAME                            READY   STATUS    RESTARTS   AGE
apache-58c94dcbc4-gp5tv         1/1     Running   0          13m â† ã“ã‚Œ!
laravel-init-644688bbcd-4n5h8   1/1     Running   0          3h20m
shell-7d945c79f8-8zc4n          1/1     Running   0          12m

PS> kubectl describe pod/apache-58c94dcbc4-gp5tv # ä¸Šè¨˜ãƒãƒƒãƒ‰åã®èª¿æŸ»
Name:             apache-58c94dcbc4-gp5tv
Namespace:        default
...(ä¸­ç•¥)...
Status:           Running
IP:               172.17.0.4
IPs:
  IP:
Controlled By:  ReplicaSet/apache-58c94dcbc4
Containers:
...(å¾Œç•¥)...
```

ã“ã‚Œã§172.17.0.4ã§ã‚ã‚‹ã¨(ä»Šå›ã®ç’°å¢ƒã§ã®è©±)ã‚ã‹ã‚Šã¾ã—ãŸã€‚
"web"ã®ä»£ã‚ã‚Šã«ã“ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç›´æ¥æŒ‡å®šã™ã‚Œã°æ¥ç¶šã¯ã§ãã¾ã™ã€‚

```{code-block} pwsh
:caption: IPç›´æ¥æŒ‡å®šã§ã®ã‚¢ã‚¯ã‚»ã‚¹(é‚ªæ‚ª)

PS> kubectl exec -it deploy/shell -- sh
/ # wget -O- 172.17.0.4
Connecting to 172.17.0.4 (172.17.0.4:80)
writing to stdout
<html><body><h1>It works!</h1></body></html>
-                    100% |***********************|    45  0:00:00 ETA
written to stdout
/ # exit
```

ã¨ã€ç¢ºã‹ã«Webãƒšãƒ¼ã‚¸(It works)ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚

ã—ã‹ã—ã€**ãƒãƒƒãƒ‰è‡ªèº«ã§ä»–ã®ãƒãƒƒãƒ‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’èª¿ã¹ã‚‹äº‹ã¯ã§ãã¾ã›ã‚“**ã€‚

## ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã£ã¦ã¿ã‚‹

ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã‚‹ã“ã¨ã§ã€ãƒãƒƒãƒ‰ã«å¯¾ã—ã¦**å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹åå‰ã‚’å‰²ã‚Šä»˜ã‘ã‚‹**ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã“ã†ã„ã†ã€ä»–ã®å­˜åœ¨ã‹ã‚‰è¦‹ã¤ã‘ã¦èŒãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã€ã¨ã„ã†è¡Œç‚ºã¯**ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒª(Service Discovery)**ã¨å‘¼ã°ã‚Œã¾ã™ã€‚
K8sã®ç’°å¢ƒã§ã¯ã€etcdã‚‚ã—ãã¯corednsã¨å‘¼ã°ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(Key-Valueå‹)ãŒä¿æŒã—ãŸå†…å®¹ã‚’DNSã®å½¢ã§å…¬é–‹ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã¨ã„ã†ã“ã¨ã§ã€Webã‚µãƒ¼ãƒãƒ¼å´ã«ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªã‚’è¨­å®šã—ã¦ã¿ã¾ã™ã€‚
vscodeã®`service`ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’ãƒ™ãƒ¼ã‚¹ã«æ›¸ãæ›ãˆã¦ã¿ã¾ã™ã€‚

```{literalinclude} codes/service-example/service-web.yml
:caption: apacheã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’ã²ã£ã‹ã‘ã¦ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹å®šç¾©(service-web.yml)
:language: yaml
```

ã“ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’é©ç”¨ã•ã›ã¦ã¿ã¾ã™ã€‚
```{code-block} pwsh
PS> kubectl apply -f service-web.yml(ã®ãƒ‘ã‚¹)
content
```

ã“ã®çŠ¶æ…‹ã§ã€å†åº¦deploy/shellå´ã«ã¦`sh`ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚‹ç«¯æœ«æ¥ç¶šã‚’è¡Œã£ã¦ãƒšãƒ¼ã‚¸å–å¾—ã‚’è©¦ã¿ã¾ã™ã€‚ãŸã ã—IPã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã¯ç„¡ãã‚µãƒ¼ãƒ“ã‚¹ã§å®šç¾©ã—ãŸåå‰(web)ã‚’ç”¨ã„ã¦è¡Œã£ã¦ã¿ã¾ã™ã€‚


```{code-block} bash
# deploy/shellã«ã¦shã§æ¥ç¶šã—ãŸçŠ¶æ…‹ã§å†ãƒ†ã‚¹ãƒˆ
/ # wget -O- web # IPã§ã¯ãªãã‚µãƒ¼ãƒ“ã‚¹ã§å®šç¾©ã—ãŸ"web"ã§
Connecting to web (10.102.171.198:80)
writing to stdout
<html><body><h1>It works!</h1></body></html> â† ã‚­ãƒã‚·ã‚¿ãƒ¯ãƒ¼
-                    100%    45  0:00:00 ETA
written to stdout
```

## ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªã®ã€ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªã€

ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒª(Discovery)ã¯ã€ç™ºè¦‹(ã™ã‚‹)ã€ã¨ã„ã†è¨€è‘‰ã§ã™ãŒã€ã‚µãƒ¼ãƒ“ã‚¹ãƒªã‚½ãƒ¼ã‚¹ã¯ã©ã†ã‚„ã£ã¦ãƒãƒƒãƒ‰ã¨ç´ä»˜ã‘ã‚’è¡Œã†ã®ã§ã—ã‚‡ã†ã€‚

ãƒãƒƒãƒ‰ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®æ¡ä»¶ãŒä¸€èˆ¬çš„ã«ç”¨ã„ã‚‰ã‚Œã¾ã™ã€‚

- ãƒãƒƒãƒ‰å´ã«ãƒ©ãƒ™ãƒ«(A)ãŒæŒ¯ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨
- Serviceãƒªã‚½ãƒ¼ã‚¹ã®ã‚»ãƒ¬ã‚¯ã‚¿ã«ã¦ãƒ©ãƒ™ãƒ«(A)ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã€‚

ä»Šå›ã®ä¾‹ã§ã¯ã€Webã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå´ã§ã¯ã“ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

```{literalinclude} codes/service-example/web.yml
:caption: web.ymlä¸Šã§ãƒãƒƒãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å¯¾ã™ã‚‹ãƒ©ãƒ™ãƒ«ä»˜ã‘
:language: yaml
:lines: 10-14
:emphasize-lines: 3,4
```

ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆçµŒç”±ã§ç”Ÿæˆã•ã‚Œã‚‹ãƒãƒƒãƒ‰ã«ã¯ã€ `app: apache` ã¨ã„ã†ãƒ©ãƒ™ãƒ«ãŒä»˜ä¸ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

ä¸€æ–¹ã€ã‚µãƒ¼ãƒ“ã‚¹å´ã¯ã“ã‚Œã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«ã‚»ãƒ¬ã‚¯ã‚¿ã§æŒ‡å®šã‚’è¡Œã„ã¾ã™ã€‚

```{literalinclude} codes/service-example/service-web.yml
:caption: ã‚»ãƒ¬ã‚¯ã‚¿ã§ã®ãƒãƒƒãƒ‰æŒ‡å®š(service-web.yml)
:language: yaml
:lines: 5-8
:emphasize-lines: 2,3
```

ã“ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€ãƒãƒƒãƒã™ã‚‹ãƒ©ãƒ™ãƒ«ã‚’æŒã¤ãƒãƒƒãƒ‰ã‚’æ¤œå‡ºã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã¯etcd(coredns)ã«é †æ¬¡ç™»éŒ²ãƒ»æ›´æ–°ã—ã¦ã„ãã¾ã™ã€‚

## ã‚µãƒ¼ãƒ“ã‚¹ã¨è¤‡æ•°ãƒãƒƒãƒãƒ³ã‚°

ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã§webå´(deploy/apache)ã‚’è¨­å®šã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚Šã€è©²å½“ãƒ©ãƒ™ãƒ«ã‚’æŒã¤ãƒãƒƒãƒ‰ãŒè¤‡æ•°ç¾ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šãˆã¾ã™ã€‚

```{code-block} pwsh
:caption: ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã«ã‚ˆã‚Š2ã¤å‹•ã‹ã™
:emphasize-lines: 1,3,5,10,11

PS> kubectl scale deploy/apache --replicas 2
deployment.apps/apache scaled
PS> kubectl get deploy,pod
NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/apache         2/2     2            2           53m
deployment.apps/laravel-init   1/1     1            1           4h
deployment.apps/shell          1/1     1            1           52m

NAME                                READY   STATUS    RESTARTS   AGE
pod/apache-58c94dcbc4-gp5tv         1/1     Running   0          53m
pod/apache-58c94dcbc4-w85b2         1/1     Running   0          38s
pod/laravel-init-644688bbcd-4n5h8   1/1     Running   0          4h
pod/shell-7d945c79f8-8zc4n          1/1     Running   0          52m
```

ã“ã®ã¨ãservice/webã¯ã©ã†ãªã‚‹ã®ã§ã—ã‚‡ã†ã€`describe`ã§ç¢ºèªã—ã¾ã™ã€‚

```{code-block} pwsh
:emphasize-lines: 1,14

PS> kubectl get svc/web
Name:              web
Namespace:         default
Labels:            <none>
Annotations:       <none>
Selector:          app=apache
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                10.102.171.198
IPs:               10.102.171.198
Port:              <unset>  80/TCP
TargetPort:        80/TCP
Endpoints:         172.17.0.4:80,172.17.0.6:80
Session Affinity:  None
Events:            <none>
```

ã¡ãªã¿ã«ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å‰ã¯ã“ã†ãªã£ã¦ã„ã¾ã™ã€‚

```{code-block}
:caption: ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å‰ã®çŠ¶æ…‹(å‚ç…§ç”¨)
:emphasize-lines: 14

PS> kubectl get svc/web
Name:              web
Namespace:         default
Labels:            <none>
Annotations:       <none>
Selector:          app=apache
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                10.102.171.198
IPs:               10.102.171.198
Port:              <unset>  80/TCP
TargetPort:        80/TCP
Endpoints:         172.17.0.4:80
Session Affinity:  None
Events:            <none>
```

ã¤ã¾ã‚Šã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ(å®Ÿéš›ã«æ¥ç¶šã•ã‚Œã‚‹ãƒãƒƒãƒ‰)ãŒã‚¹ã‚±ãƒ¼ãƒ«ã—ãŸåˆ†(åŒã˜ãƒ©ãƒ™ãƒ«ã‚’æŒã¤ã®ã§)æ•æ‰ã•ã‚ŒãŸå½¢ã«ãªã‚Šã¾ã™ã€‚

## è¤‡æ•°ãƒãƒƒãƒæ™‚ã®æ‰±ã„ã¯?

ã“ã†ãªã‚‹ã¨ã€2ã¤ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ(ãƒãƒƒãƒ‰)ã®ã©ã¡ã‚‰ã«æ¥ç¶šã•ã‚Œã‚‹ã®ã§ã—ã‚‡ã†ã‹ã€‚
ãã“ã§ã€å„ãƒãƒƒãƒ‰ã«æƒ…å ±ã‚’ä»•è¾¼ã‚“ã§å¯¾å¿œã—ã¦ã¿ã¾ã™ã€‚

```{code-block} pwsh
:caption: 2ã¤ã®ãƒãƒƒãƒ‰ã«åˆ¥ã®å†…å®¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã™ã‚‹
:emphasize-lines: 1,3,4,9,10

PS> kubectl get pods
NAME                            READY   STATUS    RESTARTS   AGE
apache-58c94dcbc4-gp5tv         1/1     Running   0          68m
apache-58c94dcbc4-z944s         1/1     Running   0          6s
laravel-init-644688bbcd-4n5h8   1/1     Running   0          4h16m
shell-7d945c79f8-8zc4n          1/1     Running   0          67m
# 2ã¤ã«ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã—ã¦ã‚‹çŠ¶æ…‹ã§ã™

PS> kubectl exec -t pod/apache-58c94dcbc4-gp5tv -- sh -c 'echo HostA | tee /usr/local/apache2/htdocs/host.txt'
HostA
PS> kubectl exec -t pod/apache-58c94dcbc4-z944s -- sh -c 'echo HostB | tee /usr/local/apache2/htdocs/host.txt'
HostB
```

ã§ã¯ã€shellå´ã‹ã‚‰ç¹°ã‚Šè¿”ã—ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã‹ã€‚

```{warning}
ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ä¾ã‚‹ã®ã§æ•°å›ã€å°‘ã—é–“ã‚’ç©ºã‘ãªãŒã‚‰ç¹°ã‚Šè¿”ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä»¥ä¸‹ã®ä¾‹ã¯ã€ãŸã¾ãŸã¾ä¸€ç™ºã§ã†ã¾ãã„ã£ãŸã€ã§ã™ã€‚
```

```{code-block} pwsh
:caption: deploy/shellã§ã‚·ã‚§ãƒ«(sh)ã‚’èµ·å‹•ã—ã¦ç¹°ã‚Šè¿”ã—ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹
/ # wget -qO- web/host.txt
HostA
/ # wget -qO- web/host.txt
HostB
```

2ã¤ä»¥ä¸Šã®ãƒãƒƒãƒ‰ãŒå¼•ã£ã‹ã‹ã‚‹å ´åˆã€**ã©ã‚Œã‹é©å½“ã«**ç¹‹ãã¨ã„ã†å‡¦ç†ã«ãªã‚Šã¾ã™ã€‚
æ•°ã‚’ã“ãªã›ã°ã ã„ãŸã„ç­‰åˆ†å‰²ã«ãªã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚

```{code-block} pwsh
:caption: è©¦ã—ã«1ä¸‡å›ã¶ã‚“ã¾ã‚ã—ã¦ã¿ã‚‹

# for i in `seq 10000`; do wget -qO- web/host.txt ;done | sort
| uniq -c
   5037 HostA
   4963 HostB
```

ã ã„ãŸã„è‰¯ã„æ„Ÿã˜ã«åˆ†æ•£ã—ã¦ã¾ã™ã­ã€‚
ãªã‚“ã¨ãªããƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼çš„ãªæ„Ÿã˜ã«ãªã£ã¦ã„ã¾ã™ã€‚

## ã‚µãƒ¼ãƒ“ã‚¹ã®ç¨®é¡

ä»Šå›ä½œã£ãŸã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã€`ClusterIP`ã¨ã„ã†ãƒ¢ãƒ¼ãƒ‰ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚

### ClusterIP

```{code-block} pwsh
:caption: service/webã‚’describeã§è¦—ãã¨
:emphasize-lines: 7

PS> kubectl describe service/web
Name:              web
Namespace:         default
Labels:            <none>
Annotations:       <none>
Selector:          app=apache
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                10.102.171.198
IPs:               10.102.171.198
Port:              <unset>  80/TCP
TargetPort:        80/TCP
Endpoints:         172.17.0.4:80,172.17.0.6:80
Session Affinity:  None
Events:            <none>
```

`ClusterIP`ã¯ã€K8sã‚¯ãƒ©ã‚¹ã‚¿ã®ä¸­ã§ã®ã¿ä½¿ãˆã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç”¨æ„ã—ã€ãƒãƒƒãƒ‰ã«ãƒãƒ¼ãƒˆã‚’ç¹‹ãå½¢ã§æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
ã“ã‚ŒãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã„ã¾ã™ã€‚

```{figure} images/service-clusterip.drawio.png
ClusterIPã®æ¦‚å¿µå›³
```

å„ãƒãƒƒãƒ‰ã¯ãƒãƒ¼ãƒ‰ã®ä¸­ã«å­˜åœ¨ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€ãƒãƒ¼ãƒ‰ã‚’è·¨ã„ã§ã‚‚ãƒãƒ¼ãƒ‰ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…ã§ãƒ‘ã‚±ãƒƒãƒˆãŒã‚«ãƒ—ã‚»ãƒ«åŒ–ã•ã‚Œã¦ä»–ã®ãƒãƒ¼ãƒ‰å†…ã®ãƒãƒƒãƒ‰ã«æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€ãƒãƒ¼ãƒ‰ã‚’ã‚ã‚‹æ„å‘³ç„¡è¦–ã—ã¦ãŠãã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

```{tip}
ClusterIPã«è¿‘ã„ã‚‚ã®ã¨ã—ã¦ã€ç‰¹å®šã®ãƒãƒ¼ãƒ‰ã®IPã¨ãƒãƒƒãƒ‰ã‚’çµã³ã¤ã‘ã‚‹ãŸã‚ã®`ExternalIP`ã¨ã„ã†ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ãŒã€
ãã†ãã†ä½¿ã†ã‚‚ã®ã§ã¯ãªã„ã®ã§çœç•¥ã—ã¾ã™ã€‚ã“ã‚Œã‚’ä½¿ã†ãªã‚‰æ¬¡ã®`NodePort`ä½¿ã£ã¦ä¸‹ã•ã„ã€‚
```

### NodePort

`NodePort`ã¯ã€ãƒãƒ¼ãƒ‰ã«å¯¾ã—ã¦ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¡Œã£ã¦æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
å­˜åœ¨ã—ã¦ã„ã‚‹ãƒãƒ¼ãƒ‰ã®å„(ä»®æƒ³)NICã®ãƒãƒ¼ãƒˆç•ªå·ã¨è©²å½“ã™ã‚‹ãƒãƒƒãƒ‰ã®é–“ã®æ¥ç¶šã‚’å¯èƒ½ã¨ã—ã¾ã™ã€‚

- ClusterIPåŒæ§˜ã€å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹å‘ã‘ã®ä»®æƒ³IPã‚’ã‚¯ãƒ©ã‚¹ã‚¿å†…ã§ç”Ÿæˆã—ã¦etc/corednsã«ã‚ˆã‚Šãƒãƒƒãƒ—ã—ã¾ã™ã€‚Podé–“ã§ã¯ã“ã®éƒ¨åˆ†ã§é€šä¿¡ã—ã¾ã™ã€‚
- ã‚¯ãƒ©ã‚¹ã‚¿ã‚’æ§‹æˆã—ã¦ã„ã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã†ã¡ã€**ãƒãƒ¼ãƒ‰ã®IPã«ã¦é©å½“ãªãƒãƒ¼ãƒˆç•ªå·ã«ã¦å¾…ã¡å—ã‘ã™ã‚‹**(ã ã‹ã‚‰NodePort)ã‚ˆã†ã«è¨­å®šã—ã€ã‚¯ãƒ©ã‚¹ã‚¿å¤–ã‹ã‚‰ã®é€šä¿¡ã¯ã“ã®ãƒãƒ¼ãƒˆã‹ã‚‰ClusterIPã«å†…éƒ¨ã§ãƒãƒƒãƒ—ã—ã¦å¯¾å¿œã—ã¾ã™ã€‚

ã“ã®å ´åˆã€ãƒãƒƒãƒ—ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹ã‚¿å†…ãƒãƒ¼ãƒ‰ã®IPã¨ã€ãƒãƒ¼ãƒ‰ã®IPãŒãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å¯èƒ½ã§æœ‰ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦ã€**ãƒãƒ¼ãƒ‰å´ã®å¾…ã¡å—ã‘ãƒãƒ¼ãƒˆç•ªå·ãŒã‚ã‹ã‚Œã°å¤–ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹**ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

```{figure} images/service-nodeport.drawio.png
NodePortã®æ¦‚å¿µå›³
```

ã§ã¯ã€ClusterIPå´ã¯ãã®ã¾ã¾æ®‹ã—ã¦ã€NodePortã§ç¹‹ãè¨­å®šã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’è¨˜è¿°ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```{literalinclude} codes/service-example/service-web-np.yml
:caption: NodePortã§webã«ç¹‹ã’ã‚‹ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ(service-web-np.yml)
:language: yaml
:emphasize-lines: 8
```

ã¨ã„ã£ã¦ã‚‚ã€å…ƒã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã€ `type: NodePort`ã‚’è¿½åŠ ã—ãŸã ã‘ã§ã™ã€‚
ã‚ã¨ã¯ClusterIPå´ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«ã€ã‚µãƒ¼ãƒ“ã‚¹åã‚’`web-np`ã«ã—ã¦ã„ã‚‹ãã‚‰ã„ã§ã—ã‚‡ã†ã€‚

ã“ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’é©ç”¨å¾Œã€ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ã‚’å‡ºåŠ›ã—ã¦ã¿ã¾ã™ã€‚

```{code-block} pwsh
PS> kubectl apply -f 'service-web-np.yml'(ã®ãƒ‘ã‚¹)
service/web-np created
PS> kubectl get svc
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
kubernetes   ClusterIP   10.96.0.1       <none>        443/TCP        9m29s
web          ClusterIP   10.109.21.105   <none>        80/TCP         8m28s # â† ClusterIP
web-np       NodePort    10.98.190.105   <none>        80:31848/TCP   8m18s # â† NodePort
```

å®Ÿéš›ã«å¤–(ãƒ–ãƒ©ã‚¦ã‚¶)ã‹ã‚‰ç¹‹ã„ã§ã¿ã¾ã—ã‚‡ã†ã€‚ã“ã“ã§ã¯ `minikube` ã®åŠ›ã‚’å€Ÿã‚Šã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

```{code-block} pwsh
:caption: minikubeã‚’ä½¿ã£ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒãƒƒãƒ‰ã®Webã‚µãƒ¼ãƒãƒ¼ã«ç¹‹ã

PS> minikube service web-np # NodePortã®ã‚µãƒ¼ãƒ“ã‚¹åã‚’æ¸¡ã—ã¦"minikube service"
|-----------|--------|-------------|---------------------------|
| NAMESPACE |  NAME  | TARGET PORT |            URL            |
|-----------|--------|-------------|---------------------------|
| default   | web-np |          80 | http://192.168.49.2:31848 |
|-----------|--------|-------------|---------------------------|
ğŸƒ  web-np ã‚µãƒ¼ãƒ“ã‚¹ç”¨ã®ãƒˆãƒ³ãƒãƒ«ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™ã€‚
|-----------|--------|-------------|------------------------|
| NAMESPACE |  NAME  | TARGET PORT |          URL           |
|-----------|--------|-------------|------------------------|
| default   | web-np |             | http://127.0.0.1:63214 |
|-----------|--------|-------------|------------------------|
ğŸ‰  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§ default/web-np ã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹ã„ã¦ã„ã¾ã™...
â—  Docker ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚’ darwin ä¸Šã§ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€å®Ÿè¡Œã™ã‚‹ã«ã¯ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚```
```{figure} images/minikube-service-web-np.png
ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒãƒƒãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹
```

ClusterIPã¯NodePortå´ã«ã‚‚ä¸ãˆã‚‰ã‚Œã€Podé–“ã®IPã¨ã—ã¦ã¯ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¿”ã•ã‚Œã¾ã™ã€‚
ãã®ä¸€æ–¹ã§ã€NodePortç‰ˆ(web-np)ã§ã¯ãƒãƒ¼ãƒˆè¨­å®šãŒ 80:**31848** ã¨ã¤ã„ã¦ã„ã¾ã™ã€‚
ã“ã®ç•ªå·ã¯ãã®æ™‚ã«ã‚ˆã‚Šãƒ©ãƒ³ãƒ€ãƒ ã§è¨­å®šã•ã‚Œã¾ã™ãŒã€ã“ã‚ŒãŒã‚¯ãƒ©ã‚¹ã‚¿å¤–ã‹ã‚‰æ¥ç¶šã™ã‚‹ã¨ãã®ãƒãƒ¼ãƒˆç•ªå·ã§ã™ã€‚

ãƒãƒ¼ãƒˆç•ªå·ãŒã‚ã‹ã£ãŸã‚‚ã®ã®ã€ãƒãƒ¼ãƒ‰ã®IPã¯ã©ã®ã‚ˆã†ã«èª¿ã¹ã‚‹ã®ã§ã—ã‚‡ã†ã€‚
ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ã§ã‚ã‚Œã°ã€ã‚‚ã¡ã‚ã‚“æä¾›ã•ã‚Œã¦ã„ã‚‹æ–¹æ³•ã§èª¿ã¹ã‚‹äº‹ã«ãªã‚Šã¾ã™ã€‚
ä»Šå›ã¯minikubeãªã®ã§ã€minikubeè‡ªèº«ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```{code-block} pwsh
:caption: ãƒãƒ¼ãƒ‰ã®IPã‚’èª¿ã¹ã‚‹
PS> minikube ip
192.168.49.2 # â†æ¤œè¨¼ã®ç’°å¢ƒã§ã¯ã“ã†å‡ºã¾ã—ãŸ
```

ã¤ã¾ã‚Šã€ãƒãƒ¼ãƒ‰å¤–ã‹ã‚‰æ¥ç¶šã™ã‚‹ã¨ãã¯ã€ http://192.168.49.2:31848/ ã§æ¥ç¶šã§ãã‚‹ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

### Dockerç’°å¢ƒã‚’ç”¨ã„ãŸminikubeç’°å¢ƒã¨ã‚µãƒ¼ãƒ“ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°

æˆæ¥­ã§ä½¿ç”¨ã—ã¦ã„ã‚‹minikubeç’°å¢ƒã¯ã€Docker Desktopã«ã‚ˆã‚‹Dockerã®ç’°å¢ƒã§æ§‹ç¯‰ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã‚ŒãŒã¡ã‚‡ã£ã¨ã‚„ã‚„ã“ã—ãã¦ã€Dockerå†…ã«æ§‹æˆã•ã‚ŒãŸminikubeã®ã‚³ãƒ³ãƒ†ãƒŠãŒå†…å´ã«å°‚ç”¨ã®Docker Engineã‚’å†…åŒ…ã—ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã‚’ "**Docker in Docker**"(DinD) ã¨å‘¼ã‚“ã§ã„ã¾ã™ã€‚

```{figure} images/docker-in-docker.drawio.png
Docker in Docker æ¦‚å¿µå›³
```

ã“ã®ã¨ãã€ `minikube ip` ã§å–å¾—ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€minikubeã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã§æ§‹æˆã—ãŸDocker Engineéƒ¨åˆ†ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãªã‚Šã¾ã™ã€‚
ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€Docker Desktopç’°å¢ƒã®å†…å´ã§æ§‹æˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ä»–ã®ã‚³ãƒ³ãƒ†ãƒŠåŒæ§˜ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚

```{figure} images/docker-in-docker-ip.drawio.png
minikube ipã®è¿”ã—ã¦ã„ãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã“ã“ã ã£ãŸ
```

ãã“ã§ã€`minikube`ã¯ã€`minikube service`ã®éš›ã« **ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãŒDockerã ã£ãŸã¨ã** ã«ã€è‡ªå‹•çš„ã«è¿½åŠ ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’èµ·å‹•ã—ã€
DinDã®ã‚³ãƒ³ãƒ†ãƒŠã¨ç¹‹ããŸã‚ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã‚’è¡Œã†è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚

```{figure} images/docker-in-docker-portforward.drawio.png
DinDã«ç¹‹ãŒã‚‹ã‚ˆã†ã«ã€Dockerã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’è¿½åŠ 
```

å®Ÿéš›ã€macOSä¸Šã§HyperKitã‚’ä½¿ã£ãŸminikubeã§ã¯ã€`minikube ip`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒãƒ¼ãƒˆç•ªå·ã§ç´ ç›´ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ãŒã€Dockerã‚’ä½¿ã£ãŸminikubeã§ã¯å¤±æ•—ã—ã¾ã™ã€‚
ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚ŒãŸã“ã¨ã¯ã€å…ˆã»ã©ã®å‡ºåŠ›ã«å«ã¾ã‚Œã¦ã„ã¾ã—ãŸã€‚

```{code-block} pwsh
:caption: minikubeã‚’ä½¿ã£ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒãƒƒãƒ‰ã®Webã‚µãƒ¼ãƒãƒ¼ã«ç¹‹ã(å†æ²)
:emphasize-lines: 7-12

PS> minikube service web-np # NodePortã®ã‚µãƒ¼ãƒ“ã‚¹åã‚’æ¸¡ã—ã¦"minikube service"
|-----------|--------|-------------|---------------------------|
| NAMESPACE |  NAME  | TARGET PORT |            URL            |
|-----------|--------|-------------|---------------------------|
| default   | web-np |          80 | http://192.168.49.2:31848 |
|-----------|--------|-------------|---------------------------|
ğŸƒ  web-np ã‚µãƒ¼ãƒ“ã‚¹ç”¨ã®ãƒˆãƒ³ãƒãƒ«ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™ã€‚
|-----------|--------|-------------|------------------------|
| NAMESPACE |  NAME  | TARGET PORT |          URL           |
|-----------|--------|-------------|------------------------|
| default   | web-np |             | http://127.0.0.1:63214 |
|-----------|--------|-------------|------------------------|
ğŸ‰  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§ default/web-np ã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹ã„ã¦ã„ã¾ã™...
â—  Docker ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚’ darwin ä¸Šã§ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€å®Ÿè¡Œã™ã‚‹ã«ã¯ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```

ã“ã®å ´åˆã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ã¯ http://127.0.0.1:63214 ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã€DinDç©ºé–“ã® http://192.168.49.2:31848 ã«è»¢é€ã•ã‚Œã€ãã“ã‹ã‚‰ClusterIPã‚’çµŒç”±ã—ã¦ã®ã‚µãƒ¼ãƒãƒ¼(ãƒãƒƒãƒ‰)ã¸ã¨å¤šæ®µæ¥ç¶šãŒè¡Œã‚ã‚Œã¾ã™ã€‚ã“ã®å‡¦ç†ã‚’è¡Œã£ã¦ã„ã‚‹é–“ã¯ç«¯æœ«ã‚’æ­¢ã‚ã‚‹ã“ã¨ãŒã§ããªã„ã®ã§æ³¨æ„ã—ã¦ä¸‹ã•ã„(Ctrl-Cã™ã‚‹ã¨åˆ‡æ–­ã•ã‚Œã‚‹)ã€‚

````{tip}
ãã®ä»–ã®ãƒ‰ãƒ©ã‚¤ãƒã‚„ç’°å¢ƒã ã¨ã©ã†ãªã®ã§ã—ã‚‡ã†ã‹?
ä¾‹ãˆã°Docker Desktopã«å†…è”µã•ã‚Œã¦ã„ã‚‹Kubernetesæ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã—ã¦ã€ç’°å¢ƒã‚’åˆ‡ã‚Šæ›¿ãˆãŸå ´åˆã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```{code-block} pwsh
PS> kubectl config get-context # ç™»éŒ²æ¸ˆK8sç’°å¢ƒã‚’ãƒã‚§ãƒƒã‚¯
CURRENT   NAME             CLUSTER          AUTHINFO         NAMESPACE
          docker-desktop   docker-desktop   docker-desktop             # Docker Desktop
*         minikube         minikube         minikube         default   # minikube

PS> kubectl config use-context docker-desktop # minikubeã«åˆ‡ã‚Šæ›¿ãˆ
Switched to context "docker-desktop".
PS> kubectl config get-contexts
CURRENT   NAME             CLUSTER          AUTHINFO         NAMESPACE
*         docker-desktop   docker-desktop   docker-desktop
          minikube         minikube         minikube         default
```

ã“ã®çŠ¶æ…‹ã§å…ˆã»ã©ä½¿ã£ã¦ã„ãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’æ¸¡ã—ã¦æ§˜å­ã‚’è¦‹ã¾ã—ã‚‡ã†ã€‚

```{code-block} pwsh
PS> kubectl apply -f 'web.yml' # Deployment
deployment.apps/apache created
PS> kubectl apply -f 'service-web-np.yml' # Service(NodePort)
service/web-np created
```

ã“ã®å ´åˆã€ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã¯Docker Desktopä¸Šã®Docker Engineã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã‚‹ãŸã‚ã€NodePortã®ãƒãƒ¼ãƒˆãŒãã®ã¾ã¾Docker Desktopç’°å¢ƒã§ã®ã‚¢ã‚¯ã‚»ã‚¹å…ˆã§ã‚ã‚‹localhost(127.0.0.1)ã«ãƒãƒƒãƒ—ã•ã‚Œã¦ã„ã¾ã™ã€‚

```{code-block} pwsh
PS> kubectl get svc
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
kubernetes   ClusterIP   10.96.0.1       <none>        443/TCP        15m
web-np       NodePort    10.102.199.29   <none>        80:30550/TCP   15s
```

ã‚ˆã£ã¦ã€ http://127.0.0.1:30550/ ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦ã—ã¾ã„ã¾ã™ã€‚

```{code-block} pwsh
PS> curl 127.0.0.1:30550
<html><body><h1>It works!</h1></body></html>
```

ã ã£ãŸã‚‰æœ€åˆã‹ã‚‰Docker Desktopã®K8sã‚’æœ‰åŠ¹ã«ã™ã‚Œã°çµ‚ã‚ã‚Šã ã£ãŸã®ã«â€¦ã¨ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€å…¨å“¡ã®ç’°å¢ƒãŒDocker Desktopã§çµ±ä¸€ã§ããªã„å ´åˆãªã©ã‚’è€ƒæ…®ã—ã¦minikubeã«ã—ã¦ã¾ã™(å®Ÿéš›ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚„ã‚¢ãƒ‰ã‚ªãƒ³ã®éƒ¨åˆ†ãŒåœ°å‘³ã«åŠ©ã‹ã‚‹ã®ã§)ã€‚

```{warning}
`NodePort`ä½¿ç”¨æ™‚ã€ãƒãƒ¼ãƒˆç•ªå·ã¯ã“ã“ã¾ã§ãŠä»»ã›ã§ã—ãŸãŒã€ç•ªå·ã‚‚æŒ‡å®šå¯èƒ½ã§ã™(spec.ports[n].nodePort)ã€‚
ã“ã®å ´åˆã€æ—¢ã«ä½¿ç”¨ä¸­ã®ãƒãƒ¼ãƒˆã ã¨å¤±æ•—ã—ã¦ã—ã¾ã„ã¾ã™(ã‚ˆãã‚ã‚‹8080ã¨ã‹ã¯å¥ªã„åˆã„ã«ãªã‚‹ã‹ã‚‚)ã€‚
```


````

### ä¸Šè¨˜ä»¥å¤–ã®typeã«ã¤ã„ã¦

åˆ©ç”¨ã™ã‚‹å¯èƒ½æ€§ã®é«˜ã„ã‚‚ã®ã¨ã—ã¦ã€ `LoadBalancer` ãŒã‚ã‚Šã¾ã™ã€‚
å¤–éƒ¨ã¨æ¥ç¶šå¯èƒ½ãªãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã‚’å†…éƒ¨ã§èµ·å‹•ã•ã›ã€å¯¾è±¡ã¨ãªã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾ã™ã‚‹ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã‚’æä¾›ã—ã¾ã™ã€‚
ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”¨ã„ã¦è² è·åˆ†æ•£ã‚’ã•ã›ã‚‹éš›ã¯ã€ã“ã¡ã‚‰ãŒä½¿ã‚ã‚Œã‚‹ã“ã¨ãŒå¤šããªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
LoadBalancerã¯ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ã§ã¯è¨­å®šã™ã‚‹ã“ã¨ã§å®Ÿéš›ã«å¤–éƒ¨ã«å¯¾ã—ã¦å›ºå®šIPã‚’ã²ã¨ã¤å‰²ã‚Šä»˜ã‘ã¦ã‚‚ã‚‰ã£ã¦å‚ç…§å¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ã‚­ã‚·ã¨ã—ã¦ã¯ã€Ingressã‚µãƒ¼ãƒ“ã‚¹ã¨é€£æºã•ã›ã‚‹ã“ã¨ã§ã€L7ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã‚‚å‡ºã¦ãã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚




## ã¾ã¨ã‚

- ãƒãƒƒãƒ‰é–“ã ã‘ã®é€šä¿¡ãŒç›®çš„ãªã‚‰ `ClusterIP` ã§è¨­å®šã—ã¦ä¿è­·ã—ã¾ã—ã‚‡ã†(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã“ã¡ã‚‰)
- å¤–éƒ¨ã¨ã®ç–é€šãŒå¿…è¦ãªã‚‚ã®ã¯ `NodePort` ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€ãã®ä¸Šã§ `minikube service ã‚µãƒ¼ãƒ“ã‚¹å` ã§ãƒ‰ãƒ©ã‚¤ãƒå›ºæœ‰è¨­å®šã‚’åŠ ãˆã¦ç¹‹ã”ã†

## å‚è€ƒæ–‡çŒ®

- [ã‚ãªãŸã®çŸ¥ã‚‰ãªã„Kubernetesã®Serviceã®ä»•çµ„ã¿(IIJ Engineers Blog)](https://eng-blog.iij.ad.jp/archives/9998)
